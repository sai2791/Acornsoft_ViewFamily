from commands import *
import acorn

load(0x8000, "viewspell.rom", "65c02")

acorn.bbc()
acorn.is_sideways_rom()
config.set_show_stats(True)
config.set_show_autogenerated_labels(False)
config.set_label_references(True)
config.set_include_assertions(False)
config.set_hex_dump(True)


def inline_string_hook(target, addr):
    n = stringhiz(addr + 3)
    b = get_u8_binary(n)
    if b == 0:
        return n + 1
    return None


def decode_parser_table(addr):
    saddr = addr
    name = ""
    index = 0
    while True:
        b = get_u8_binary(addr)
        if b == 0:
            break
        if b >= 0x80:
            comment(saddr, f"'{name}' -> {index}, flag={b & 0x7f}")
            byte(saddr, len(name))

            name = ""
            saddr = addr + 1
            index += 1
        else:
            name += chr((b ^ ord("[")) & 0xDF)
        addr += 1


def labelword(addr, name):
    word(addr, 2)
    label(addr, name)
    expr_label(addr + 0, f"{name}+0")
    expr_label(addr + 1, f"{name}+1")


def absaddr8(addr):
    addr = memorymanager.BinaryAddr(addr)
    val = memory_binary[addr]
    runtime_addr = movemanager.b2r(addr)
    auto_expr(runtime_addr, str(val))


def immaddr8(addr):
    addr = memorymanager.BinaryAddr(addr)
    label = get_label(
        memory_binary[addr],
        addr,
        binary_addr_type=BinaryAddrType.BINARY_ADDR_IS_AT_LABEL_USAGE,
    )
    runtime_addr = movemanager.b2r(addr)
    auto_expr(runtime_addr, label)


def immaddr(addr_lo, addr_hi):
    addr_lo = memorymanager.BinaryAddr(addr_lo)
    addr_hi = memorymanager.BinaryAddr(addr_hi)
    label = get_label(
        (memory_binary[addr_hi] << 8) | memory_binary[addr_lo],
        addr_lo,
        binary_addr_type=BinaryAddrType.BINARY_ADDR_IS_AT_LABEL_USAGE,
    )
    lo_runtime_addr = movemanager.b2r(addr_lo)
    hi_runtime_addr = movemanager.b2r(addr_hi)
    auto_expr(lo_runtime_addr, make_lo(label))
    auto_expr(hi_runtime_addr, make_hi(label))

entry(0x8029)
subroutine(0x802d, "call_osbyte")
subroutine(0x8030, "get_text_cursor_position", "gets the x,y co-ordinate of the cursor", "Gets the current text cursor poxition", None, {'x' : "X pos", 'y' : "y vpos"}, False, None, False)
subroutine(0x9f5e, "sub_9f5e")
subroutine(0x9c15, "sub_9c15")

subroutine(0x9c3d,"sub_9c3d")
entry(0x9c45)
entry(0x9c46)
entry(0x9c5f)
subroutine(0x9c68, "sub_9c68")
entry(0x9cd9)
subroutine(0x9cda, "sub_9cda")
subroutine(0x9225, "sub_9225")
subroutine(0x9241, "sub_9241")
subroutine(0x91e7, "sub_91e7")
subroutine(0x91f4, "sub_91f4")
string(0x92ef)
string(0x9302)
string(0x9313)
entry(0x92f7)
entry(0x9308)
entry(0x9319)
entry(0xb008)
subroutine(0xaf1f, "sub_af1f")
subroutine(0xb162, "sub_b162")
subroutine(0xb1bd, "sub_b1bd")
subroutine(0xb38c, "sub_b38c")
string(0xb443)
string(0xb457)
subroutine(0xb5f2, "sub_b5f2")
subroutine(0xb627, "sub_b627")
subroutine(0xb639, "sub_b639")
subroutine(0xb8d8, "sub_b8d8")
subroutine(0xb88c, "sub_b88c")
subroutine(0xb98e, "sub_b98e")
subroutine(0xb9bc, "sub_b9bc")
subroutine(0xb9d4, "sub_b9d4")
subroutine(0xb9da, "sub_b9da")
subroutine(0xb9eb, "sub_b9eb")
subroutine(0xb9f6, "sub_b9f6")
subroutine(0xba01, "sub_ba01")
subroutine(0xba15, "sub_ba15")
subroutine(0xba23, "sub_ba23")
subroutine(0xba37, "sub_ba37")
subroutine(0xba63, "sub_ba63")
subroutine(0xba6e, "sub_ba6e")
subroutine(0xba80, "sub_ba80")
subroutine(0xba87, "sub_ba87")
subroutine(0xbada, "sub_bada")
subroutine(0xbae1, "sub_bae1")
subroutine(0xbe2e, "sub_be2e")
label(0x868f, "osword_read_line_block")
subroutine(0x8697, "sub_8697")
subroutine(0x86f6, "sub_86f6")
subroutine(0x8729, "sub_8729")
subroutine(0x8733, "sub_8733")
subroutine(0x87a3, "sub_87a3")
subroutine(0x87c6, "sub_87c6")
label(0x87c9, "nick_dean")
string(0x87c9)
subroutine(0x8805, "sub_8805")
subroutine(0x8828, "sub_8828")
entry(0x8859)
label(0x8853, "print_saving")
string(0x9b97)
entry(0x9b9a)
subroutine(0x9ba3, "increment_stack_return_address")
subroutine(0x9b9f, "print_inline_string")
entry(0x87d2)

subroutine(0x9bae, "not_a_page_boundary")
subroutine(0x9bc9, "check_for_token")
subroutine(0x9bd0, "check_for_underline_token")
subroutine(0x9be1, "check_for_backtick_token")
subroutine(0x9b86, "check_for_percent_token")
subroutine(0x9b6c, "call_osasci")
entry(0x9b91)
string(0x9be8)
subroutine(0x9be5, "print_space_words")
string(0x9efa)
entry(0x9f00)
subroutine(0x9f01, "sub_9f01")
label(0x9ec4, "datatable_1")
subroutine(0x9c3d, "print_bad_file")
subroutine(0x9b94, "print_bad")
string(0x9c40)
byte(0x9f4a, 5)
entry(0x9f4f)
wordentry(0x9f70, 33)
subroutine(0xb98b, "call_via_ind2v")
subroutine(0xa483, "sub_a483")
label(0xa32c, "datatable_2")
label(0xa32b, "datatable_3")
entry(0xa9ea)
subroutine(0xaa70, "sub_aa70")
subroutine(0xaa76, "sub_aa76")
subroutine(0xaaa2, "sub_aaa2")
label(0xab13, "datatable_4")
subroutine(0xab56, "sub_ab56")
subroutine(0xab63, "sub_ab63")
string(0xab81)
string(0xab8c)
entry(0xab86)
label(0xabc5, "bad_syntax")
string(0xacb0)
string(0xae29)
entry(0xae3f)
entry(0xae30)
entry(0xae24)
string(0xae33)
label(0xb23c, "text_Spell")
label(0xb242, "text_Sheet")
label(0xb248, "text_Store")
label(0xb24e, "text_VIEW")
label(0xb43e, "command_table")
label(0xb4fe, "text_keeping")
label(0xb50c, "text_c")
entry(0xb97a)
label(0x0df0, "rom_workspace_array")
subroutine(0x8fa6, "sub_8fa6")
subroutine(0x9049, "sub_9049")
subroutine(0x9063, "sub_9063")
string(0x9071)
entry(0x9078)
string(0x93c9)
entry(0xa32c)
entry(0x93d3)
subroutine(0x93d4, "sub_93d4")
label(0x93c6, "print_bad_directory")
subroutine(0x93eb, "sub_93e6")
subroutine(0x94f5, "sub_94f5")
string(0x94cd)
subroutine(0x94ca, "print_not_space")
string(0x94d4)
subroutine(0x94d0, "print_found")
subroutine(0x94eb, "print_CR_word")
subroutine(0x9564, "print_CR_in")
string(0x956e)
subroutine(0x956b, "print_master")
string(0x9578)
entry(0x9582)
subroutine(0x9575, "print_dictionary")
subroutine(0x95fa, "print_CR_in_user")
entry(0x9604)
byte(0x9605,7)
byte(0x960c,8)
label(0x9692, "text_full")
label(0x9908, "jumptable0_commands")
wordentry(0x9908,21)
subroutine(0x8989, "cmark_cmd")
subroutine(0x9410, "create_cmd")
label(0x62, "output_file_handle")
label(0x9401, "datatable_7")
subroutine(0x94db, "delete_word_cmd")
subroutine(0x94df, "add_word_cmd")
subroutine(0x80cd, "read_user_command_from_prompt")
subroutine(0x80ab, "os_escape_flag_set")
subroutine(0x80dd, "acknowledge_escape_pressed")
label(0x80e2, "print_escape")
entry(0x80ed)
subroutine(0x80ee, "check_os_escape_flag")
label(0xff, "os_escape_flag")
entry(0x80f9)
subroutine(0x80f3, "print_input_cursor")
comment(0x80f6, "decodes to =>", align=Align.INLINE)
label(0x484, "input_buffer")
subroutine(0x8109, "not_a_star_command")
subroutine(0x8143, "print_mistake")
subroutine(0x9258, "convert_to_upper")
subroutine(0x925b, "set_carry_flag_based_on_case")
subroutine(0x9263, "clear_carry_as_lowercase")
subroutine(0x8985, "mark_cmd")
subroutine(0x899a, "context_cmd")
subroutine(0x9239, "convert_a_reg_to_uppercase")
subroutine(0x929f, "prefix_cmd")
subroutine(0x92ec, "print_prefix_settings")
label(0x9336, "text_too_long")
subroutine(0x9324, "print_prefix_text")
string(0x82eb)
label(0x82fd, "print_bytes_free")
subroutine(0x82d8, "print_viewspell_heading_details")
subroutine(0x82ce, "change_mode")
label(0x08, "mode")
subroutine(0x826e, "print_CR_memory_full")
entry(0x827e)
string(0x82ac)
subroutine(0x82a9, "print_bad_mode")
subroutine(0x827f, "mode_cmd")
comment(0x828d, "higher than a number?", align=Align.INLINE)
comment(0x8291, "less than 0?", align=Align.INLINE)
label(0x16, "mode_requested")
entry(0x830b)
byte(0x832f,4)
entry(0x8333)
string(0x833f)
entry(0x8346)
string(0x835a)
entry(0x8366)
subroutine(0x833a, "print_source")
subroutine(0x8355, "print_screen_mode")
entry(0x82f8)
subroutine(0x836a, "print_single_digit_number")
subroutine(0x8029, "get_current_screen_mode")
label(0x8037, "default_master_dictionary")
label(0x4b, "editing_file_flag")
subroutine(0x843b, "get_oshwm")
no_automatic_comment(0x8054)
comment(0x8054,"Clears the screen", align=Align.INLINE)
comment(0x805c, "brk Handler routine at 85a5", align=Align.INLINE)
subroutine(0x85a5, "brk_handler_routine")
subroutine(0x9bd4, "print_cr_if_cursor_xpos_is_not_zero")
no_automatic_comment(0x843d)
comment(0x843d, "get value for page",align=Align.INLINE)
labelword(0x18, "original_page")
subroutine(0x8445, "fix_up_page")
subroutine(0x844c, "page_lsb_is_not_zero")
subroutine(0x8474, "check_page_is_consistent")
labelword(0x001f, "page")
label(0x437, "dictionary_directory_name")
subroutine(0x94a2, "check_file_exists")
subroutine(0x94a7, "get_file_information")
subroutine(0x8084, "print_insert_disk_press_key")
string(0x8095)
no_automatic_comment(0x8092)
subroutine(0x82db, "print_viewspell_heading")
entry(0x808f)
entry(0x80a6)
subroutine(0x83f9, "print_newline_save_cursor")
subroutine(0x83cb, "populate_prefix_array")
subroutine(0x83a9, "wipe_variables_from_00_to_8e")
entry(0x839d)
subroutine(0x883e, "save_cmd")
subroutine(0x8859, "list_cmd")
string(0x890b)
label(0x890b, "print_marking")
label(0x6f, "file_handle_2")
subroutine(0x9cbf, "open_file_for_input")
subroutine(0x9cc1, "call_osfind_with_block")
subroutine(0x94c4, "get_file_info_then_print_filename_not_found")
subroutine(0x94c7, "print_CR_filename_not_found")
subroutine(0x8516, "print_CR_then_filename")
byte(0x94d0)
subroutine(0x94d1, "print_found")



go()
